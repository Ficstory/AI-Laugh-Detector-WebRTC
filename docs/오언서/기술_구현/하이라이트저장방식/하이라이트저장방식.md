- [하이라이트 저장 방식](#-----------)
  * [1️⃣ 클라이언트 기반 저장](#1--------------)
  * [2️⃣ 미디어 서버(SFU) 기반 스트림 버퍼링 후 하이라이트 저장](#2----------sfu-----------------------)
    + [이 방식의 정석 구조: 서버 링버퍼 + 이벤트로 커밋](#-----------------------------)
  * [프레임 기반 AI 판단 vs SFU 기반 버퍼링/저장 차이](#-------ai----vs-sfu-------------)
- [🌟 우리 프로젝트에서는 뭐가 더 적합할까?](#------------------------)
- [하이라이트 저장 장소는?](#-------------)

# 하이라이트 저장 방식

## 1️⃣ 클라이언트 기반 저장

- 각 클라이언트가
    - 자신의 영상을 로컬 링버퍼로 유지
    - 웃음 발생 시 전후 몇 초를 파일로 저장
- 서버로 업로드하거나 각자 재생

문제점

- 8인에서 실패 확률 높음
- 싱크/품질 불일치
- 탭 종료, 네트워크 이슈에 취약

→ 실무에서는거의 안씀 

## 2️⃣ 미디어 서버(SFU) 기반 스트림 버퍼링 후 하이라이트 저장

- 미디어 서버란?
    
    WebRTC SFU 같은 영상 흐름의 허브
    
    핵심은 영상이 이미 서버를 지나가니까, 서버가 저장/리플레이를 훨씬 안정적으로 할 수 있음
    

### 이 방식의 정석 구조: 서버 링버퍼 + 이벤트로 커밋

1. 클라이언트 → WebRTC → SFU 로 스트림 송출
2. SFU 가 각 스트림을
    - 최근 N 초만 임시로 저장(메모리/순환 디스크 캐시)
    - 계속 덮어쓰기(전체 녹화 X)
3. 웃음 이벤트 수신
4. SFU 버퍼에서 (t - 3) - (t + 2) 정도를 잘라서 clip 파일로 저장
5. 그 클립을 모든 참가자에게 재생(리플레이)

- 링버퍼란?
    
    정해진 크기만 유지하면서, 오래된 데이터는 자동으로 덮어쓰는 순환형 버퍼
    

특징

- 저장 주체: SFU/서버
- 저장 대상: 스트림
- 저장 방식: 링버퍼 → 이벤트 시 커밋

장점

- 1:1 ~ 8인 모두 안정적
- 저장 성공률/싱크/품질 우수
- 모두가 같은 리플레이를 봄

단점

- SFU/Recorder 구성 필요
- 서버가 영상을 다루므로 정책 설계 필요

## 프레임 기반 AI 판단 vs SFU 기반 버퍼링/저장 차이

| 구분 | 프레임 기반 AI 판단(서버 판정) | SFU 기반 버퍼링/저장 |
| --- | --- | --- |
| 중심 목적 | **웃음 판정** | **하이라이트 저장/리플레이** |
| 서버가 받는 핵심 데이터 | 저fps **프레임(이미지)** | WebRTC **스트림(영상/음성)** |
| 전후 N초 저장 | 별도 설계 필요(프레임만으론 불충분) | 구조 자체가 “링버퍼→커밋” |
| 공정성 | 중앙 판정 가능 | 중앙 판정도 가능 + 저장 일관성↑ |
| 구현 난이도 | AI 파이프라인은 단순할 수 있음, 저장이 어려워짐 | SFU/Recorder가 필요하지만 저장은 깔끔 |

# 🌟 우리 프로젝트에서는 뭐가 더 적합할까?

하이라이트 저장을 SFU 기반으로 처리하면 영상 스트림이 이미 서버를 통과하고 있기 때문에 추가적인 업로드나 동기화 과정없이 안정적으로 저장이 가능하다.

SFU 또는 연결된 Recorder 가 스트림을 서버 기준 시간으로 최근 N초만 링버퍼 형태로 유지하고 있기 때문에 웃음 판정 이벤트가 발생했을 때 해당 시점을 기준으로 전후 구간을 정확하게 잘라낼 수 있다.

이 방식은 각 클라이언트가 개별적으로 영상을 저장하는 경우 발생할 수 있는 저장 실패, 싱크 불일치, 화질 차이 문제를 방지한다.

또한 서버에서 하나의 하이라이트 클립을 생성하여 모든 참가자에게 제공할 수 있어, 모두가 동일한 장면을 동일한 시점으로 리플레이할 수 있다.

따라서 SFU 기반 하이라이트 저장 방식은 다인원 화상회의 환경에서 저장 성공률, 영상 일관성, 리플레이 품질 측면에서 가장 안정적인 선택이다.

# 하이라이트 저장 장소는?

## 안건1: 로컬에 저장

H2나 SQLite 같은 데이터베이스를 처음에 고려했다. 하지만 H2랑 SQLite는 영상 같은 파일을 저장하는 용도가 아니라, 아이디나 상태값, 결과 같은 글자·숫자 데이터를 저장하는 데이터베이스이다. 그래서 mp4 같은 영상을 거기에 넣으려고 하면 오히려 구조가 망가진다.

S3를 못 쓰는 상황이라면, 그냥 EC2 서버 안의 디스크에 파일로 저장하면 된다. 말 그대로 서버 컴퓨터에 폴더 하나 만들어서`highlight.mp4` 같은 파일을 거기에 넣는 방식이다.

그리고 데이터베이스(MySQL)에는 “이 하이라이트 파일이 어디에 있다”라는 **경로만 저장**하면 된다.

나중에 웹에서 프로필 이미지를 보여줄 내는 브라우저가 그 이미지 URL로 요청하면 서버가 **그** 파일을 그대로 내려주는 방식(**정적 파일 서빙**)이다.

하지만 주어진 것만 쓰지 않고 S3도 고려를 한 번 해봐야 할 것 같다 !