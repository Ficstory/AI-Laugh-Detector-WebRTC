# ğŸ‘” Jenkins Guide

ë³¸ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ì˜ CI/CDë¥¼ ë‹´ë‹¹í•˜ëŠ” **Jenkins Pipeline**ì˜ êµ¬ì¡°ì™€ ì„¤ì •, ìš´ì˜ ë°©ë²•ì„ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.
í˜„ì¬ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ `Jenkinsfile`ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

---

## ğŸ—ï¸ Pipeline Overview

JenkinsëŠ” Git Repository(`develop`, `main`)ì˜ ë³€í™”ë¥¼ ê°ì§€í•˜ì—¬ ìë™ìœ¼ë¡œ ë¹Œë“œ ë° ë°°í¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
ë¹Œë“œ ìƒíƒœ ë° ê²°ê³¼ëŠ” **Mattermost**ë¥¼ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.

### Multi-Branch Pipeline
- **`develop` Branch**: Dev í™˜ê²½ ë°°í¬ (ë§¤ Push ë§ˆë‹¤ ìˆ˜í–‰)
- **`main` Branch**: Prod í™˜ê²½ ë°°í¬ (ë°°í¬ ìŠ¹ì¸ ë˜ëŠ” Push ì‹œ ìˆ˜í–‰)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CI/CD Pipeline Flow                             â”‚
â”‚                                                                        â”‚
â”‚   [Git Push] â”€â”€â”€â”€â”€â–º [Checkout] â”€â”€â”€â”€â”€â–º [Prepare]                        â”‚
â”‚                                          â”‚                             â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚          â–¼                                                    â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Develop Pipelineâ”‚                                â”‚ Main Pipeline  â”‚ â”‚
â”‚  â”‚                 â”‚                                â”‚                â”‚ â”‚
â”‚  â”‚ 1. Build (Dev)  â”‚                                â”‚ 1. Det. Target â”‚ â”‚
â”‚  â”‚ 2. Deploy (Dev) â”‚                                â”‚    (Blue/Green)â”‚ â”‚
â”‚  â”‚ 3. Health Check â”‚                                â”‚ 2. Build (Prod)â”‚ â”‚
â”‚  â”‚ 4. Smoke Test   â”‚                                â”‚ 3. Deploy      â”‚ â”‚
â”‚  â”‚ 5. Status Reportâ”‚                                â”‚ 4. Health Checkâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚ 5. Switch Trfc â”‚ â”‚
â”‚                                                     â”‚ 6. Smoke Test  â”‚ â”‚
â”‚                                                     â”‚ 7. Status Rpt  â”‚ â”‚
â”‚                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“œ Stages Breakdown

### 1. Checkout & Prepare
- Git Repositoryì—ì„œ ìµœì‹  ì½”ë“œë¥¼ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.
- `scripts/*.sh` ë° `gradlew` ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
- ë¹Œë“œ ì‹œì‘ ì•Œë¦¼ì„ Mattermostë¡œ ì „ì†¡í•©ë‹ˆë‹¤.

### 2. Build (Backend & Frontend)
- **Backend**: `gradle build`ë¥¼ ìˆ˜í–‰í•˜ì§€ë§Œ, ì‹¤ì œ ìš´ì˜ ë°°í¬ ì‹œì—ëŠ” Docker Compose ë‚´ë¶€ì—ì„œ Buildë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- **Frontend**: ë¡œì»¬ ë¹Œë“œëŠ” ìƒëµí•˜ê³  Docker ë°°í¬ ì‹œ Multi-stage buildë¥¼ í†µí•´ ê²°ê³¼ë¬¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
- Jenkins Credential(`app-yml`)ì—ì„œ `application.yml`ì„ ì£¼ì…í•©ë‹ˆë‹¤.

### 3. Deploy (Docker Compose)
- **Dev**: `make dev-app-up` ëª…ë ¹ì–´ë¡œ ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ì¬ìƒì„±í•©ë‹ˆë‹¤.
- **Prod**: Blue/Green ì „ëµì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
  - **Determine Target**: í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ(`prod-was-blue/green`)ì™€ Nginx ì„¤ì •ì„ í™•ì¸í•˜ì—¬ ë°°í¬ ëŒ€ìƒì„ ìë™ìœ¼ë¡œ ê²°ì •í•©ë‹ˆë‹¤.
  - Jenkins Credential(`env-prod`)ì—ì„œ `.env.prod`ë¥¼ ì£¼ì…í•©ë‹ˆë‹¤.
  - `make prod-app-up`ì„ í†µí•´ íƒ€ê²Ÿ í™˜ê²½(ì˜ˆ: Green)ì„ ë°°í¬í•©ë‹ˆë‹¤.

### 4. Health Check
- ë°°í¬ëœ ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ìš”ì²­ì„ ë°›ì„ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
- **Method**: `/actuator/health` ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
- **Retry**: ìµœëŒ€ 30íšŒ, 2~3ì´ˆ ê°„ê²©ìœ¼ë¡œ ì‹œë„í•©ë‹ˆë‹¤.

### 5. Switch Traffic (Prod Only)
- Health Checkê°€ í†µê³¼í•˜ë©´ `scripts/switch-upstream.sh`ë¥¼ ì‹¤í–‰í•˜ì—¬ Nginx íŠ¸ë˜í”½ì„ ì‹ ê·œ ë²„ì „ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.
- ìë™ ë¡¤ë°±: ë°°í¬ ì‹¤íŒ¨ ì‹œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë‹¤ì‹œ ì „í™˜ì„ ì‹œë„í•©ë‹ˆë‹¤.

---

## ğŸ”‘ Credentials & Environment Variables

í”„ë¡œì íŠ¸ì˜ ë³´ì•ˆ ì •ë³´ëŠ” Jenkinsì˜ **Manage Credentials**ì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.

### Required Credentials
| ID | Type | Description |
|---|---|---|
| `env-dev` | Secret File | Dev í™˜ê²½ë³€ìˆ˜ (`.env.dev` ë‚´ìš© ì „ì²´) |
| `env-prod` | Secret File | Prod í™˜ê²½ë³€ìˆ˜ (`.env.prod` ë‚´ìš© ì „ì²´) |
| `frontend-env-dev` | Secret File | Frontend Dev í™˜ê²½ë³€ìˆ˜ (`frontend/.env.dev`) |
| `frontend-env-prod` | Secret File | Frontend Prod í™˜ê²½ë³€ìˆ˜ (`frontend/.env.prod`) |
| `app-yml` | Secret File | `application.yml` (Spring ì„¤ì •) |
| `mattermost-webhook` | Secret Text | ë°°í¬ ì•Œë¦¼ìš© Webhook URL |

---

## ğŸš¨ Troubleshooting

### 1. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
- Production ë°°í¬ê°€ ì‹¤íŒ¨í•˜ë©´ íŒŒì´í”„ë¼ì¸ì´ ìë™ìœ¼ë¡œ ë¡¤ë°±ì„ ì‹œë„í•©ë‹ˆë‹¤.
- ìë™ ë¡¤ë°± ì‹¤íŒ¨ ì‹œ ë§¤ë‰´ì–¼ ë¡¤ë°±:
  ```bash
  # Blueë¡œ ë¡¤ë°±
  make switch-blue
  ```

### 2. Health Check Failed
- **ì¦ìƒ**: "Health Check Failed" ì—ëŸ¬ì™€ í•¨ê»˜ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨.
- **í•´ê²°**: Jenkins ë¡œê·¸ì—ì„œ `docker logs` ì¶œë ¥ì„ í™•ì¸í•˜ì—¬ Spring Boot ê¸°ë™ ì—ëŸ¬(DB ì—°ê²° ë“±)ë¥¼ ë¶„ì„í•˜ì„¸ìš”.

### 3. Mattermost ì•Œë¦¼ ë¯¸ìˆ˜ì‹ 
- Webhook URLì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
- `curl` ëª…ë ¹ì–´ë¡œ Webhook URLì´ ìœ íš¨í•œì§€ ì„œë²„ì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“ Script Reference

ì£¼ìš” ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” `scripts/` ë””ë ‰í† ë¦¬ì— ìœ„ì¹˜í•©ë‹ˆë‹¤.

- `deploy-blue.sh` / `deploy-green.sh`: ê°œë³„ í™˜ê²½ ë°°í¬
- `switch-upstream.sh`: Nginx ì„¤ì • ë³€ê²½ (Blue <-> Green)
- `health-check.sh`: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
