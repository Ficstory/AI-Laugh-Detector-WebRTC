# =============================================================================
# Development Override - Single WAS Configuration
# =============================================================================
# 사용법: docker compose -f docker-compose.dev.yml up -d
#
# 개발 환경은 단일 WAS 인스턴스만 실행합니다.
# =============================================================================

services:
  # ===========================================================================
  # Development WAS (단일 인스턴스)
  # ===========================================================================
  dev-was:
    build:
      context: .
      dockerfile: Dockerfile
    image: dev-was-app:latest
    container_name: dev-was
    restart: always
    expose:
      - "8080"
    env_file:
      - ../.env.dev
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8080
      - SERVER_SSL_ENABLED=false
      - TZ=Asia/Seoul
      - JAVA_OPTS=-Xms512m -Xmx1024m
      - LOG_LEVEL=DEBUG

      # JWT
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}

      # MySQL (dev-net의 dev-mysql 컨테이너)
      - MYSQL_HOST=dev-mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      
      # Redis (Hostname override)
      - REDIS_HOST=dev-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=

      # MinIO (Endpoint overrides & Credentials mapping)
      - MINIO_ENDPOINT=http://dev-minio:9000
      - MINIO_EXTERNAL_ENDPOINT=${MINIO_EXTERNAL_ENDPOINT:-http://localhost:9000}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET=profile-images

      # JWT
      # JWT_SECRET_KEY는 env_file에서 자동 로드됨

      # OAuth
      - KAKAO_REST_API_KEY=${KAKAO_REST_API_KEY}
      - KAKAO_REDIRECT_URL=${KAKAO_REDIRECT_URL}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - NAVER_REST_API_KEY=${NAVER_REST_API_KEY}
      - NAVER_REDIRECT_URL=${NAVER_REDIRECT_URL}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
      - GOOGLE_REST_API_KEY=${GOOGLE_REST_API_KEY}
      - GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      
      # CORS
      - APP_CORS_ALLOWED_ORIGINS=${APP_CORS_ALLOWED_ORIGINS}

      # OpenVidu (개발용 - 선택)
      - OPENVIDU_URL=${OPENVIDU_URL}
      - OPENVIDU_SECRET=${OPENVIDU_SECRET}
    networks:
      - dev-net
    volumes:
      - ./logs:/app/logs
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

# =============================================================================
# Networks - dev-net은 data compose에서 생성, 여기서는 외부 참조
# =============================================================================
networks:
  dev-net:
    external: true
