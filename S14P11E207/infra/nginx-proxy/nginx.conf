# =============================================================================
# Nginx Reverse Proxy - ë©”ì¸ ì„¤ì •
# =============================================================================
#
# ğŸ“‹ ê°œìš”:
#   - ëª¨ë“  ì™¸ë¶€ íŠ¸ë˜í”½ì˜ ë‹¨ì¼ ì§„ì…ì 
#   - Production/Development í™˜ê²½ ë¼ìš°íŒ…
#   - Blue/Green ë°°í¬ ì§€ì›
#
# ğŸŒ ë¼ìš°íŒ… ê·œì¹™:
#   /           â†’ prod-frontend (Production)
#   /api/*      â†’ prod-was (Blue/Green)
#   /grafana/*  â†’ grafana (Monitoring)
#   /dev        â†’ dev-frontend (Development)
#   /dev/api/*  â†’ dev-was
#
# =============================================================================

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    # -----------------------------------------------------------------------
    # ë™ì‹œ ì—°ê²° ìˆ˜ ì„¤ì •
    # -----------------------------------------------------------------------
    worker_connections 1024;
    use epoll;          # Linux ìµœì í™”
    multi_accept on;    # ë‹¤ì¤‘ ì—°ê²° ë™ì‹œ ìˆ˜ë½
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # íŒŒì¼ ì—…ë¡œë“œ í¬ê¸° ì œí•œ (í”„ë¡œí•„ ì´ë¯¸ì§€ ë“±)
    client_max_body_size 20M;

    # =========================================================================
    # ë¡œê·¸ í¬ë§· (ìƒì„¸ ì •ë³´ í¬í•¨)
    # =========================================================================
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log main;

    # =========================================================================
    # ì„±ëŠ¥ ìµœì í™”
    # =========================================================================
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # =========================================================================
    # Gzip ì••ì¶•
    # =========================================================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript
               application/xml application/xml+rss text/javascript application/x-javascript
               application/wasm application/octet-stream;

    # =========================================================================
    # ë³´ì•ˆ í—¤ë”
    # =========================================================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # =========================================================================
    # Upstream ì •ì˜ (Blue/Green ë°°í¬ìš©)
    # =========================================================================
    #
    # âš ï¸ Blue/Green ì „í™˜ ì‹œ prod-was upstreamë§Œ ìˆ˜ì •
    # ìŠ¤í¬ë¦½íŠ¸: /scripts/switch-upstream.sh
    #
    # =========================================================================

    # -----------------------------------------------------------------------
    # Production Services
    # -----------------------------------------------------------------------

    # Production WAS - Blue/Green ì „í™˜ ëŒ€ìƒ
    upstream prod-was {
        # Blue ì„œë²„ (í™œì„±)
        server prod-was-blue:8081;

        # Green ì„œë²„ (ëŒ€ê¸°) - ì „í™˜ ì‹œ ì£¼ì„ êµì²´
        # server prod-was-green:8082;

        keepalive 32;
    }

    # Production Frontend
    upstream prod-frontend {
        server prod-frontend:80;
        keepalive 16;
    }

    # -----------------------------------------------------------------------
    # Development Services
    # -----------------------------------------------------------------------

    # Development Services (Dev ë°°í¬ í—ˆìš©)
    upstream dev-was {
        server dev-was:8080;
        keepalive 16;
    }

    upstream dev-frontend {
        server dev-frontend:5173;
        keepalive 8;
    }

    # -----------------------------------------------------------------------
    # Monitoring Services
    # -----------------------------------------------------------------------

    # Grafana
    upstream grafana {
        server grafana:3000;
        keepalive 4;
    }

    # =========================================================================
    # Server Block (HTTP)
    # =========================================================================
    server {
        listen 80;
        server_name _;

        # í´ë¼ì´ì–¸íŠ¸ ìµœëŒ€ ìš”ì²­ í¬ê¸° (íŒŒì¼ ì—…ë¡œë“œìš©)
        client_max_body_size 100M;

        # ---------------------------------------------------------------------
        # Production Frontend (/)
        # ---------------------------------------------------------------------
        location / {
            proxy_pass http://prod-frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------------------------------------------------------------------
        # Production API (/api/*)
        # ---------------------------------------------------------------------
        location /api/ {
            proxy_pass http://prod-was/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # íƒ€ì„ì•„ì›ƒ ì„¤ì •
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ---------------------------------------------------------------------
        # OpenVidu Webhook (/api/webhook)
        # OpenVidu â†’ Prod & Dev WASë¡œ ë™ì‹œ ì „ë‹¬ (ë©€í‹°ìºìŠ¤íŠ¸)
        # ---------------------------------------------------------------------
        location /api/webhook {
            # ë©”ì¸ ì‘ë‹µì€ Production WASì—ì„œ ë°›ê¸°
            proxy_pass http://prod-was/webhook;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Content-Type application/json;

            # Webhookì€ ë¹ ë¥´ê²Œ ì²˜ë¦¬ë˜ì–´ì•¼ í•¨
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;

            # ë¡œê¹… í™œì„±í™” (ë””ë²„ê¹…ìš©)
            access_log /var/log/nginx/webhook_access.log main;
            error_log /var/log/nginx/webhook_error.log warn;

            # â­ Mirror: Dev WASì—ë„ ë™ì‹œ ì „ì†¡ (ì‘ë‹µì€ ë¬´ì‹œ)
            mirror /webhook-mirror-dev;
            mirror_request_body on;
        }

        # Development WAS Mirror (ë‚´ë¶€ location)
        location /webhook-mirror-dev {
            internal;  # ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨
            proxy_pass http://dev-was/webhook;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Content-Type application/json;
            proxy_connect_timeout 2s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;

            # MirrorëŠ” ì—ëŸ¬ ë¬´ì‹œ
            proxy_ignore_client_abort on;

            # Mirror ë¡œê·¸ (ì„ íƒ)
            access_log /var/log/nginx/webhook_mirror_dev.log main;
        }

        # ---------------------------------------------------------------------
        # Grafana (/grafana/*)
        # ---------------------------------------------------------------------
        location /grafana/ {
            proxy_pass http://grafana;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------------------------------------------------------------------
        # Jenkins (/jenkins/)
        # ---------------------------------------------------------------------
        location /jenkins {
            proxy_pass http://jenkins:8080;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------------------------------------------------------------------
        # Production MinIO (/objects/ -> /)
        # ---------------------------------------------------------------------
        location /objects/ {
            # íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•œ ìµœëŒ€ body í¬ê¸° ì„¤ì •
            client_max_body_size 10M;

            rewrite ^/objects/(.*) /$1 break;
            proxy_pass http://prod-minio:9000;
            proxy_http_version 1.1;

            # MinIO S3 API í˜¸í™˜ì„ ìœ„í•œ í—¤ë” ì„¤ì •
            proxy_set_header Host prod-minio:9000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # PUT/DELETE ë©”ì„œë“œ í—ˆìš©
            proxy_method $request_method;

            # íƒ€ì„ì•„ì›ƒ ì„¤ì • (ëŒ€ìš©ëŸ‰ íŒŒì¼ ì—…ë¡œë“œ)
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
        }

        # ---------------------------------------------------------------------
        # Development Frontend (/dev)
        location /dev {
            proxy_pass http://dev-frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Development API (/dev/api/)
        location /dev/api/ {
            proxy_pass http://dev-was/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------------------------------------------------------------------
        # Development MinIO (/dev/objects/ -> /)
        # ---------------------------------------------------------------------
        location /dev/objects/ {
            # íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•œ ìµœëŒ€ body í¬ê¸° ì„¤ì •
            client_max_body_size 10M;

            rewrite ^/dev/objects/(.*) /$1 break;
            proxy_pass http://dev-minio:9000;
            proxy_http_version 1.1;

            # MinIO S3 API í˜¸í™˜ì„ ìœ„í•œ í—¤ë” ì„¤ì •
            proxy_set_header Host dev-minio:9000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # PUT/DELETE ë©”ì„œë“œ í—ˆìš©
            proxy_method $request_method;

            # íƒ€ì„ì•„ì›ƒ ì„¤ì • (ëŒ€ìš©ëŸ‰ íŒŒì¼ ì—…ë¡œë“œ)
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
        }

        # ---------------------------------------------------------------------
        # Health Check Endpoint
        # ---------------------------------------------------------------------
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

    # =========================================================================
    # HTTPS Server Block (SSL ì ìš© ì‹œ ì£¼ì„ í•´ì œ)
    # =========================================================================
    # =========================================================================
    # HTTPS Server Block (SSL ì ìš©)
    # =========================================================================
    server {
        listen 443 ssl http2;
        server_name _;

        # SSL ì¸ì¦ì„œ ê²½ë¡œ (infra/nginx-proxy/ssl/ì— íŒŒì¼ ìœ„ì¹˜ì‹œì¼œì•¼ í•¨)
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
        ssl_prefer_server_ciphers off;

        # HSTS
        add_header Strict-Transport-Security "max-age=63072000" always;

        # ê³µí†µ ì„¤ì • (HTTP ë¸”ë¡ê³¼ ë™ì¼)
        client_max_body_size 100M;

        # Frontend
        location / {
            proxy_pass http://prod-frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # API
        location /api/ {
            proxy_pass http://prod-was/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # OpenVidu Webhook (HTTPS)
        # OpenVidu â†’ Prod & Dev WASë¡œ ë™ì‹œ ì „ë‹¬ (ë©€í‹°ìºìŠ¤íŠ¸)
        location /api/webhook {
            # ë©”ì¸ ì‘ë‹µì€ Production WASì—ì„œ ë°›ê¸°
            proxy_pass http://prod-was/webhook;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Content-Type application/json;
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
            access_log /var/log/nginx/webhook_access.log main;
            error_log /var/log/nginx/webhook_error.log warn;

            # â­ Mirror: Dev WASì—ë„ ë™ì‹œ ì „ì†¡ (ì‘ë‹µì€ ë¬´ì‹œ)
            mirror /webhook-mirror-dev-https;
            mirror_request_body on;
        }

        # Development WAS Mirror (HTTPS ë‚´ë¶€ location)
        location /webhook-mirror-dev-https {
            internal;  # ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨
            proxy_pass http://dev-was/webhook;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Content-Type application/json;
            proxy_connect_timeout 2s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
            proxy_ignore_client_abort on;
            access_log /var/log/nginx/webhook_mirror_dev.log main;
        }

        # Grafana
        location /grafana/ {
            proxy_pass http://grafana;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Jenkins
        location /jenkins {
            proxy_pass http://jenkins:8080;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------------------------------------------------------------------
        # Development Frontend (/dev) - HTTPS ì§€ì›
        # ---------------------------------------------------------------------
        location /dev {
            proxy_pass http://dev-frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Development API (/dev/api/) - HTTPS ì§€ì›
        location /dev/api/ {
            proxy_pass http://dev-was/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Development MinIO (/dev/objects/ -> /) - HTTPS ì§€ì›
        location /dev/objects/ {
            # íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•œ ìµœëŒ€ body í¬ê¸° ì„¤ì •
            client_max_body_size 10M;

            rewrite ^/dev/objects/(.*) /$1 break;
            proxy_pass http://dev-minio:9000;
            proxy_http_version 1.1;

            # MinIO S3 API í˜¸í™˜ì„ ìœ„í•œ í—¤ë” ì„¤ì •
            proxy_set_header Host dev-minio:9000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # PUT/DELETE ë©”ì„œë“œ í—ˆìš©
            proxy_method $request_method;

            # íƒ€ì„ì•„ì›ƒ ì„¤ì • (ëŒ€ìš©ëŸ‰ íŒŒì¼ ì—…ë¡œë“œ)
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
        }

        # MinIO (Production) - HTTPS ì§€ì›
        location /objects/ {
            # íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•œ ìµœëŒ€ body í¬ê¸° ì„¤ì •
            client_max_body_size 10M;

            rewrite ^/objects/(.*) /$1 break;
            proxy_pass http://prod-minio:9000;
            proxy_http_version 1.1;

            # MinIO S3 API í˜¸í™˜ì„ ìœ„í•œ í—¤ë” ì„¤ì •
            proxy_set_header Host prod-minio:9000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # PUT/DELETE ë©”ì„œë“œ í—ˆìš©
            proxy_method $request_method;

            # íƒ€ì„ì•„ì›ƒ ì„¤ì • (ëŒ€ìš©ëŸ‰ íŒŒì¼ ì—…ë¡œë“œ)
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
        }

        # Health Check
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
