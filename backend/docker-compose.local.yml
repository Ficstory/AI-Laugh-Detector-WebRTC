# =============================================================================
# ë¡œì»¬ ê°œë°œ í™˜ê²½ ì„¤ì • (Local Development - Full Stack)
# =============================================================================
#
# ğŸ“‹ ê°œìš”:
#   - ê°œë°œì ë¡œì»¬ PCì—ì„œ ì „ì²´ ìŠ¤íƒ ì‹¤í–‰
#   - ëª¨ë“  ì„œë¹„ìŠ¤(DB + WAS)ê°€ í•˜ë‚˜ì˜ composeì— í¬í•¨
#   - EC2ì™€ ë‹¬ë¦¬ ë¶„ë¦¬ ì—†ì´ ë‹¨ìˆœí•˜ê²Œ ìš´ì˜
#
# ğŸš€ ì‚¬ìš©ë²•:
#   cd backend
#   docker compose -f docker-compose.local.yml up -d --build
#
# âš ï¸ ì£¼ì˜:
#   - ì´ íŒŒì¼ì€ ADR#003 ë¶„ë¦¬ ì•„í‚¤í…ì²˜ì™€ ë‹¤ë¦…ë‹ˆë‹¤
#   - ë¡œì»¬ ê°œë°œ í¸ì˜ë¥¼ ìœ„í•´ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ í•˜ë‚˜ë¡œ ë¬¶ìŒ
#   - EC2 ë°°í¬ ì‹œì—ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”!
#
# ğŸ”§ í™˜ê²½ë³€ìˆ˜:
#   - backend/.env íŒŒì¼ì„ ì°¸ì¡°í•©ë‹ˆë‹¤
#
# =============================================================================

services:
  # ===========================================================================
  # MySQL Database (ë¡œì»¬ìš©)
  # ===========================================================================
  mysql:
    image: mysql:8.0
    container_name: mysql-local
    restart: always
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    ports:
      - "${MYSQL_LOCAL_PORT:-3307}:3306"  # ê¸°ë³¸ê°’ 3307, .envì—ì„œ ë³€ê²½ ê°€ëŠ¥
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-local-data:/var/lib/mysql
    networks:
      - local-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Redis Cache (ë¡œì»¬ìš©)
  # ===========================================================================
  redis:
    image: redis:alpine
    container_name: redis-local
    restart: always
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_LOCAL_PORT:-6380}:6379"  # ê¸°ë³¸ê°’ 6380, .envì—ì„œ ë³€ê²½ ê°€ëŠ¥
    volumes:
      - redis-local-data:/data
    networks:
      - local-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # MinIO Object Storage (ë¡œì»¬ìš©)
  # ===========================================================================
  minio:
    image: minio/minio:latest
    container_name: minio-local
    restart: always
    ports:
      - "9000:9000"   # MinIO API
      - "9001:9001"   # MinIO Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-local-data:/data
    networks:
      - local-net
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ===========================================================================
  # WAS Application (ë¡œì»¬ìš© - ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤)
  # ===========================================================================
  was:
    build:
      context: .
      dockerfile: Dockerfile
    image: was-local:latest
    container_name: was-local
    restart: always
    ports:
      - "${WAS_LOCAL_PORT:-8081}:${WAS_LOCAL_PORT:-8081}"
    environment:
      # -----------------------------------------------------------------------
      # Spring ì„¤ì •
      # -----------------------------------------------------------------------
      - SPRING_PROFILES_ACTIVE=local
      - SERVER_PORT=${WAS_LOCAL_PORT:-8081}
      - SERVER_SSL_ENABLED=false
      - JAVA_OPTS=-Xms256m -Xmx512m

      # -----------------------------------------------------------------------
      # JWT
      # -----------------------------------------------------------------------
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}

      # -----------------------------------------------------------------------
      # MySQL (Docker ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë¡œ ì—°ê²°)
      # -----------------------------------------------------------------------
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}

      # -----------------------------------------------------------------------
      # Redis (Docker ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë¡œ ì—°ê²°)
      # -----------------------------------------------------------------------
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # -----------------------------------------------------------------------
      # MinIO (Docker ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë¡œ ì—°ê²°)
      # -----------------------------------------------------------------------
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}

      # -----------------------------------------------------------------------
      # OAuth (ë¡œì»¬ ê°œë°œìš© - backend/.envì—ì„œ ì„¤ì •)
      # -----------------------------------------------------------------------
      - KAKAO_REST_API_KEY=${KAKAO_REST_API_KEY}
      - KAKAO_REDIRECT_URL=${KAKAO_REDIRECT_URL}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - NAVER_REST_API_KEY=${NAVER_REST_API_KEY}
      - NAVER_REDIRECT_URL=${NAVER_REDIRECT_URL}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
      - GOOGLE_REST_API_KEY=${GOOGLE_REST_API_KEY}
      - GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

      # -----------------------------------------------------------------------
      # OpenVidu (ì„ íƒ - backend/.envì—ì„œ ì„¤ì •)
      # -----------------------------------------------------------------------
      - OPENVIDU_URL=${OPENVIDU_URL:-}
      - OPENVIDU_SECRET=${OPENVIDU_SECRET:-}
    volumes:
      - ./logs:/app/logs
    networks:
      - local-net
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

# =============================================================================
# Networks
# =============================================================================
networks:
  local-net:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mysql-local-data:
    name: mysql-local-data
  redis-local-data:
    name: redis-local-data
  minio-local-data:
    name: minio-local-data
