# =============================================================================
# Production Override - WAS Configuration
# =============================================================================
# 사용법: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# =============================================================================

services:
  prod-was-blue:
    env_file:
      - ../.env.prod
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms1024m -Xmx2048m -XX:+UseG1GC -XX:MaxGCPauseMillis=200
      - LOG_LEVEL=INFO

      # MySQL (Hostname override)
      - MYSQL_HOST=prod-mysql
      - MYSQL_PORT=3306

      # Redis (Hostname override)
      - REDIS_HOST=prod-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=

      # MinIO (Endpoint overrides)
      - MINIO_ENDPOINT=http://prod-minio:9000
      - MINIO_EXTERNAL_ENDPOINT=${MINIO_EXTERNAL_ENDPOINT}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET=profile-images

      # JWT
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}

      # OAuth
      - KAKAO_REST_API_KEY=${KAKAO_REST_API_KEY}
      - KAKAO_REDIRECT_URL=${KAKAO_REDIRECT_URL}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - NAVER_REST_API_KEY=${NAVER_REST_API_KEY}
      - NAVER_REDIRECT_URL=${NAVER_REDIRECT_URL}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
      - GOOGLE_REST_API_KEY=${GOOGLE_REST_API_KEY}
      - GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

      # OpenVidu
      - OPENVIDU_URL=${OPENVIDU_URL}
      - OPENVIDU_SECRET=${OPENVIDU_SECRET}
      
      # CORS
      - APP_CORS_ALLOWED_ORIGINS=${APP_CORS_ALLOWED_ORIGINS}
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  prod-was-green:
    env_file:
      - ../.env.prod
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms1024m -Xmx2048m -XX:+UseG1GC -XX:MaxGCPauseMillis=200
      - LOG_LEVEL=INFO

      # MySQL (Hostname override)
      - MYSQL_HOST=prod-mysql
      - MYSQL_PORT=3306

      # Redis (Hostname override)
      - REDIS_HOST=prod-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=

      # MinIO (Endpoint overrides)
      - MINIO_ENDPOINT=http://prod-minio:9000
      - MINIO_EXTERNAL_ENDPOINT=${MINIO_EXTERNAL_ENDPOINT}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET=profile-images

      # JWT
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}

      # OAuth
      - KAKAO_REST_API_KEY=${KAKAO_REST_API_KEY}
      - KAKAO_REDIRECT_URL=${KAKAO_REDIRECT_URL}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - NAVER_REST_API_KEY=${NAVER_REST_API_KEY}
      - NAVER_REDIRECT_URL=${NAVER_REDIRECT_URL}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
      - GOOGLE_REST_API_KEY=${GOOGLE_REST_API_KEY}
      - GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

      # OpenVidu
      - OPENVIDU_URL=${OPENVIDU_URL}
      - OPENVIDU_SECRET=${OPENVIDU_SECRET}

      # CORS
      - APP_CORS_ALLOWED_ORIGINS=${APP_CORS_ALLOWED_ORIGINS}
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
