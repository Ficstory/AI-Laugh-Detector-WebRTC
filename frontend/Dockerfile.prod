# =============================================================================
# Frontend Production Dockerfile (Multi-stage Build)
# =============================================================================
#
# ğŸ“‹ ê°œìš”:
#   - Stage 1: Node.js í™˜ê²½ì—ì„œ ë¹Œë“œ
#   - Stage 2: Nginxë¡œ ì •ì  íŒŒì¼ ì„œë¹™
#
# ğŸš€ ë¹Œë“œ:
#   docker build -f Dockerfile.prod -t prod-frontend:latest .
#
# ğŸ’¡ ìµœì í™”:
#   - ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œë¡œ ì´ë¯¸ì§€ í¬ê¸° ìµœì†Œí™”
#   - ë¹Œë“œ ìºì‹œ í™œìš©ìœ¼ë¡œ ë¹ ë¥¸ ì¬ë¹Œë“œ
#
# =============================================================================

# =============================================================================
# Stage 1: Build Stage
# =============================================================================
FROM node:22-alpine AS builder

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ë¹Œë“œ ì¸ì (í™˜ê²½ë³€ìˆ˜ë¡œ ì „ë‹¬)
ARG VITE_API_URL=/api
ARG VITE_KAKAO_CLIENT_ID
ARG VITE_NAVER_CLIENT_ID
ARG VITE_GOOGLE_CLIENT_ID

ENV VITE_API_URL=${VITE_API_URL}
ENV VITE_KAKAO_CLIENT_ID=${VITE_KAKAO_CLIENT_ID}
ENV VITE_NAVER_CLIENT_ID=${VITE_NAVER_CLIENT_ID}
ENV VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}

# -----------------------------------------------------------------------
# ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ìµœì í™”)
# -----------------------------------------------------------------------
# package*.jsonë§Œ ë¨¼ì € ë³µì‚¬í•˜ì—¬ ì˜ì¡´ì„± ë ˆì´ì–´ ìºì‹±
# ì†ŒìŠ¤ ì½”ë“œ ë³€ê²½ ì‹œì—ë„ ì˜ì¡´ì„± ì¬ì„¤ì¹˜ ë°©ì§€
# -----------------------------------------------------------------------
COPY package.json package-lock.json ./
RUN npm ci --only=production=false

# -----------------------------------------------------------------------
# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ ë° ë¹Œë“œ
# -----------------------------------------------------------------------
COPY . .
RUN npm run build

# =============================================================================
# Stage 2: Production Stage
# =============================================================================
FROM nginx:alpine AS production

# -----------------------------------------------------------------------
# Nginx ì„¤ì • ë³µì‚¬
# -----------------------------------------------------------------------
# SPA ë¼ìš°íŒ…ì„ ìœ„í•œ try_files ì„¤ì • í¬í•¨
# -----------------------------------------------------------------------
COPY nginx.prod.conf /etc/nginx/conf.d/default.conf

# -----------------------------------------------------------------------
# ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
# -----------------------------------------------------------------------
# Stage 1ì—ì„œ ë¹Œë“œëœ dist í´ë”ë§Œ ë³µì‚¬
# -----------------------------------------------------------------------
COPY --from=builder /app/dist /usr/share/nginx/html

# -----------------------------------------------------------------------
# í—¬ìŠ¤ì²´í¬ìš© curl ì„¤ì¹˜
# -----------------------------------------------------------------------
RUN apk add --no-cache curl

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 80

# Nginx ì‹¤í–‰
CMD ["nginx", "-g", "daemon off;"]
